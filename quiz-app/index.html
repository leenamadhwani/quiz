<!DOCTYPE html>
<html>
<head>
  <title>Quiz System</title>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- jsPDF for Certificate -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial; padding: 20px; }
    input { padding: 8px; width: 250px; }
    button { padding: 10px 20px; margin-top: 10px; cursor: pointer; }
    #quizSection, #resultSection { margin-top: 20px; }
  </style>
</head>

<body>

  <!-- ------------------------------ -->
  <!-- REGISTRATION SECTION -->
  <!-- ------------------------------ -->

  <h2>Register</h2>

  <input id="name" placeholder="Full Name"><br><br>
  <input id="email" placeholder="Email"><br><br>

  <button onclick="registerUser()">Register</button>

  <hr>

  <!-- ------------------------------ -->
  <!-- QUIZ SECTION -->
  <!-- ------------------------------ -->

  <div id="quizSection" style="display:none;">
    <h2>Quiz</h2>

    <div id="quiz"></div>

    <button onclick="submitQuiz()">Submit Quiz</button>
  </div>

  <hr>

  <!-- ------------------------------ -->
  <!-- RESULT + CERTIFICATE -->
  <!-- ------------------------------ -->

  <div id="resultSection" style="display:none;">
    <h2>Your Score: <span id="scoreText"></span></h2>
    <button onclick="downloadCertificate()">Download Certificate (PDF)</button>
  </div>


  <!-- ------------------------------------------------- -->
  <!-- ðŸ“Œ **FULL WORKING SCRIPT â€” NO CHANGES REQUIRED** -->
  <!-- ------------------------------------------------- -->
  <script>

    /* -------------------------------------------
       1. CONNECT SUPABASE
    ------------------------------------------- */
    const SUPABASE_URL = "https://itwalbzaeltqnhdarbru.supabase.co";
    const SUPABASE_KEY = "sb_publishable_sNY9MDn25D8kKIEpRlbR7Q_whTjA2sK";

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


    let currentUserId = null;
    let currentQuizId = null;
    let attemptId = null;
    let questionMap = [];



    /* -------------------------------------------
       2. STATIC QUIZ QUESTIONS (Frontend)
    ------------------------------------------- */
    const quizData = [
      {
        question: "What is the capital of India?",
        options: ["Mumbai", "Delhi", "Kolkata", "Chennai"],
        correct: 1
      },
      {
        question: "HTML is used for?",
        options: ["Backend", "Database", "Frontend", "AI"],
        correct: 2
      },
      {
        question: "2 + 2 = ?",
        options: ["3", "4", "5", "6"],
        correct: 1
      }
    ];



    /* -------------------------------------------
       3. INSERT QUIZ + QUESTIONS + OPTIONS
    ------------------------------------------- */
    async function insertQuizToDB() {

      // Insert Quiz
      let { data: quiz } = await supabase
        .from("quizzes")
        .insert([{ title: "Sample Quiz", description: "Basic MCQs" }])
        .select();

      currentQuizId = quiz[0].id;


      // Insert Questions + Options
      for (let q of quizData) {

        let { data: insertedQ } = await supabase
          .from("quiz_questions")
          .insert([{ quiz_id: currentQuizId, question_text: q.question }])
          .select();

        let questionId = insertedQ[0].id;

        // Map frontend â†’ DB question ID
        questionMap.push({
          questionId: questionId,
          correctIndex: q.correct
        });

        // Insert options for this question
        for (let i = 0; i < q.options.length; i++) {
          await supabase.from("quiz_options").insert([
            {
              question_id: questionId,
              option_text: q.options[i],
              is_correct: i === q.correct
            }
          ]);
        }
      }
    }



    /* -------------------------------------------
       4. REGISTER USER
    ------------------------------------------- */
    async function registerUser() {

      const fullName = document.getElementById("name").value;
      const email = document.getElementById("email").value;

      let { data } = await supabase
        .from("users")
        .insert([{ full_name: fullName, email }])
        .select();

      currentUserId = data[0].id;

      alert("Registration Successful!");

      // Show Quiz
      document.getElementById("quizSection").style.display = "block";

      // Insert quiz into DB
      await insertQuizToDB();

      loadQuiz();
    }



    /* -------------------------------------------
       5. DISPLAY QUIZ ON SCREEN
    ------------------------------------------- */
    function loadQuiz() {

      const quizDiv = document.getElementById("quiz");
      quizDiv.innerHTML = "";

      quizData.forEach((q, index) => {
        let html = `<p><b>${index + 1}. ${q.question}</b></p>`;

        q.options.forEach((opt, i) => {
          html += `
                <label>
                  <input type="radio" name="q${index}" value="${i}">
                  ${opt}
                </label><br>
              `;
        });

        quizDiv.innerHTML += html + "<br>";
      });
    }



    /* -------------------------------------------
       6. SUBMIT QUIZ + SAVE TO DATABASE
    ------------------------------------------- */
    async function submitQuiz() {

      // Start attempt
      let { data: attempt } = await supabase
        .from("quiz_attempts")
        .insert([{ user_id: currentUserId, quiz_id: currentQuizId }])
        .select();

      attemptId = attempt[0].id;

      let score = 0;


      // Loop through questions
      for (let i = 0; i < quizData.length; i++) {

        let selected = document.querySelector(`input[name="q${i}"]:checked`);
        if (!selected) continue;

        let selectedIndex = parseInt(selected.value);

        let isCorrect = selectedIndex === quizData[i].correct;

        if (isCorrect) score++;

        let questionId = questionMap[i].questionId;

        await supabase.from("quiz_answers").insert([
          {
            attempt_id: attemptId,
            question_id: questionId,
            selected_option_id: selectedIndex,
            is_correct: isCorrect
          }
        ]);
      }


      // Update score
      await supabase
        .from("quiz_attempts")
        .update({ score })
        .eq("id", attemptId);


      document.getElementById("scoreText").innerText = score;
      document.getElementById("resultSection").style.display = "block";
    }



    /* -------------------------------------------
       7. DOWNLOAD CERTIFICATE PDF
    ------------------------------------------- */
    function downloadCertificate() {

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(22);
      doc.text("Certificate of Achievement", 55, 40);

      doc.setFontSize(14);
      doc.text(`Awarded to:`, 20, 60);
      doc.text(document.getElementById("name").value, 20, 70);

      doc.text(`Score: ${document.getElementById("scoreText").innerText}`, 20, 85);

      doc.save("certificate.pdf");
    }

  </script>

</body>
</html>
